<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>BRIN Live Overview</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; color: darkslategrey; overflow-x: hidden; }
        body::before { content: ""; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: none; opacity: 0.2; z-index: -1; }
        video#bg-video { position: fixed; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: -2; opacity: 0.4; }
        header { background-image: linear-gradient(to right, lightseagreen, palevioletred); color: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; position: fixed; width: 100%; top: 0; z-index: 1000; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); }
        .logo { display: flex; align-items: center; cursor: pointer; }
        .logo img { height: 40px; vertical-align: middle; }
        .logo span { margin-left: 10px; font-size: 16px; font-weight: bold; }
        .header-right { display: flex; align-items: center; }
        .header-right span { margin-right: 20px; font-size: 14px; }
        .main-content { margin-left: 0; padding: 80px 20px 20px; min-height: 100vh; }
        .main-content-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px; }
        .toolbar { position: fixed; top: 60px; left: -400px; width: 200px; height: 100%; background-image: linear-gradient(to bottom, lightseagreen, palevioletred); padding: 15px; box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1); transition: left 0.3s ease-in-out; z-index: 999; overflow-y: auto; }
        .toolbar.active { left: 0; }
        .toolbar .feature-box { background-color: lightgrey; border-radius: 8px; padding: 12px; margin-bottom: 16px; color: white; font-size: 13px; }
        .toolbar .feature-box h3 { margin: 0 0 8px; font-size: 14px; color: black; }
        .toolbar .feature-box button { width: 100%; padding: 6px; background-color: darkgrey; color: black; border: none; border-radius: 5px; cursor: pointer; font-size: 11px; margin-bottom: 4px; transition: background-color 0.3s; }
        .toolbar .feature-box button:hover { background-color: darkslategrey; }
        .toolbar .user-info { text-align: center; }
        .toolbar .user-info img { width: 40px; height: 40px; border-radius: 50%; margin-bottom: 8px; }
        .toolbar .user-info span { display: block; margin: 4px 0; font-size: 11px; color: black; }
        .overview, .user-details { background-color: lightgrey; padding: 10px; border-radius: 8px; border: 2px solid #dc3545; min-height: 150px; }
        .overview h1 { margin: 0 0 10px; color: #007bff; font-size: 16px; }
        .stats { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 10px; font-size: 12px; }
        .stats div { background-color: #e9ecef; padding: 6px; border-radius: 5px; text-align: center; }
        .stats span:first-child { display: block; font-size: 12px; font-weight: bold; color: #555; margin-bottom: 5px; }
        .stats span:last-child { font-size: 12px; color: #007bff; }
        .user-details h2 { margin-top: 0; color: #007bff; font-size: 16px; }
        .user-details .detail { margin-bottom: 10px; font-size: 14px; }
        .user-details .detail label { font-weight: bold; display: block; color: #555; }
        .user-details .detail span { color: #007bff; }
        .user-details .actions { display: flex; justify-content: space-between; }
        .user-details .actions button { padding: 8px 12px; border: none; border-radius: 5px; cursor: pointer; font-size: 12px; transition: background-color 0.3s; }
        .user-details .actions .in-btn { background-color: green; color: white; }
        .user-details .actions .in-btn:hover { background-color: darkgreen; }
        .user-details .actions .out-btn { background-color: red; color: white; }
        .user-details .actions .out-btn:hover { background-color: darkred; }
    </style>
</head>
<body>
    <video id="bg-video" autoplay muted loop>
        <source src="https://github.com/Defdava/Digital-Twin-Website-used/blob/main/wave.mp4?raw=true" type="video/mp4">
        Your browser does not support the video tag.
    </video>
    <header>
        <div class="logo" id="toggleToolbar">
            <img src="https://github.com/Defdava/Digital-Twin-Website-used/blob/main/Logo_BRIN.png?raw=true" alt="BRIN Logo">
            <span>BRIN</span>
            <span>Badan Riset Nasional</span>
        </div>
        <div class="header-right">
            <span>Parking Management System</span>
        </div>
    </header>
    <aside class="toolbar" id="toolbar">
        <div class="feature-box user-info" id="userInfo">
            <h3>User</h3>
            <img id="profilePic" src="/assets/user.JPG" alt="User">
            <span>Welcome Back</span>
            <span id="userName"></span>
            <button class="profile" onclick="window.location.href='profile.html'">Profile</button>
            <button class="logout">Log Out</button>
        </div>
    </aside>
    <main class="main-content">
        <div class="main-content-grid">
            <div class="overview">
                <h1>Live Overview</h1>
                <div class="stats">
                    <div><span>Cars</span><span id="occupiedSlots">0 / 20</span></div>
                    <div><span>Slots</span><span id="emptySlots">20 / 20</span></div>
                    <div><span>Time</span><span id="currentTime"></span></div>
                    <div><span>Loyalty Customers</span><span>3</span></div>
                    <div><span>Total Cars In</span><span>74 Today</span></div>
                    <div><span>Total Cars Out</span><span>32 Today</span></div>
                </div>
            </div>
            <div class="user-details">
                <h2>User Details</h2>
                <div class="detail">
                    <label>Nama:</label>
                    <span id="detailName"></span>
                </div>
                <div class="detail">
                    <label>ID Karyawan:</label>
                    <span id="detailIdWorker"></span>
                </div>
                <div class="detail">
                    <label>Plat Nomor Mobil:</label>
                    <span id="detailPlate"></span>
                </div>
                <div class="detail">
                    <label>Pilih Slot Parkir:</label>
                    <select id="slotSelect">
                        <option value="">-- Pilih Slot --</option>
                        <script>
                            for (let i = 1; i <= 20; i++) {
                                document.write(`<option value="slot_${i}">Slot ${i}</option>`);
                            }
                        </script>
                    </select>
                </div>
                <div class="actions">
                    <button class="in-btn">Mobil Masuk</button>
                    <button class="out-btn">Mobil Keluar</button>
                </div>
            </div>
        </div>
    </main>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAef3SJwvVVTunr6CWki79aenfpXlgYc0s",
            authDomain: "digitaltwinparkingbrin.firebaseapp.com",
            databaseURL: "https://digitaltwinparkingbrin-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "digitaltwinparkingbrin",
            storageBucket: "digitaltwinparkingbrin.appspot.com",
            messagingSenderId: "608462498913",
            appId: "1:608462498913:web:73695d8c91f923e2db8e20",
            measurementId: "G-F1TRY65RTG"
        };

        firebase.initializeApp(firebaseConfig);
        const dbRef = firebase.database().ref("slot_parking");

        function updateLiveOverview(occupiedCount, emptyCount, totalSlots) {
            document.getElementById('occupiedSlots').textContent = `${occupiedCount} / ${totalSlots}`;
            document.getElementById('emptySlots').textContent = `${emptyCount} / ${totalSlots}`;
        }

        function setupFirebaseListener() {
            dbRef.on("value", (snapshot) => {
                const data = snapshot.val() || {};
                let occupiedCount = 0;
                const totalSlots = 20;
                for (let i = 1; i <= totalSlots; i++) {
                    if (data[`slot_${i}`] === true) occupiedCount++;
                }
                const emptyCount = totalSlots - occupiedCount;
                updateLiveOverview(occupiedCount, emptyCount, totalSlots);
            });
        }

        function sendSlotMessage(slotKey, action, user) {
            if (!slotKey) {
                alert('Pilih slot parkir terlebih dahulu!');
                return;
            }
            const timestamp = new Date();
            const options = { timeZone: 'Asia/Jakarta', hour: 'numeric', minute: '2-digit', second: '2-digit', hour12: false };
            const timeString = new Intl.DateTimeFormat('en-US', options).format(timestamp) + ' WIB';

            firebase.database().ref(`slot_message_user/${slotKey}`).set({
                lastAction: action,
                user: user.username,
                idWorker: user.idWorker,
                plate: 'MH 27 CA 2305',
                timestamp: timeString
            }).then(() => {
                alert(`✅ ${action} untuk ${slotKey} berhasil dikirim!`);
            }).catch(err => {
                console.error('❌ Gagal mengirim pesan:', err);
            });
        }

        document.addEventListener("DOMContentLoaded", () => {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (!currentUser) {
                alert('Silakan login terlebih dahulu!');
                window.location.replace('login.html');
                return;
            }
            document.getElementById('userName').textContent = currentUser.username;
            document.getElementById('profilePic').src = currentUser.profilePic || '/assets/user.JPG';
            document.getElementById('detailName').textContent = currentUser.username;
            document.getElementById('detailIdWorker').textContent = currentUser.idWorker;
            document.getElementById('detailPlate').textContent = 'MH 27 CA 2305';

            document.querySelector('.logout').addEventListener('click', () => {
                localStorage.removeItem('currentUser');
                alert('Berhasil logout!');
                window.location.replace('login.html');
            });

            document.getElementById('toggleToolbar').addEventListener('click', () => {
                document.getElementById('toolbar').classList.toggle('active');
            });

            function updateClock() {
                const now = new Date();
                const options = { timeZone: 'Asia/Jakarta', hour: 'numeric', minute: '2-digit', second: '2-digit', hour12: false };
                document.getElementById('currentTime').textContent = new Intl.DateTimeFormat('en-US', options).format(now) + ' WIB';
            }
            updateClock();
            setInterval(updateClock, 1000);

            setupFirebaseListener();

            document.querySelector('.in-btn').addEventListener('click', () => {
                const selectedSlot = document.getElementById('slotSelect').value;
                sendSlotMessage(selectedSlot, 'Mobil Masuk', currentUser);
            });

            document.querySelector('.out-btn').addEventListener('click', () => {
                const selectedSlot = document.getElementById('slotSelect').value;
                sendSlotMessage(selectedSlot, 'Mobil Keluar', currentUser);
            });
        });
    </script>
</body>
</html>
