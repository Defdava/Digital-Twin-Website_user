<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>BRIN Live Overview</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 0; 
            padding: 0; 
            color: darkslategrey; 
            overflow-x: hidden; 
        }
        body::before { 
            content: ""; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: none; 
            opacity: 0.2; 
            z-index: -1; 
        }
        video#bg-video { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
            z-index: -2; 
            opacity: 0.4; 
        }
        header { 
            background-image: linear-gradient(to right, lightseagreen, palevioletred); 
            color: white; 
            padding: 10px 20px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            position: fixed; 
            width: 100%; 
            top: 0; 
            z-index: 1000; 
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); 
        }
        .logo { 
            display: flex; 
            align-items: center; 
            cursor: pointer; 
        }
        .logo img { 
            height: 40px; 
            vertical-align: middle; 
        }
        .logo span { 
            margin-left: 10px; 
            font-size: 16px; 
            font-weight: bold; 
        }
        .header-right { 
            display: flex; 
            align-items: center; 
        }
        .header-right span { 
            margin-right: 20px; 
            font-size: 14px; 
        }
        .main-content { 
            margin-left: 0; 
            padding: 80px 20px 20px; 
            min-height: 100vh; 
        }
        .main-content-grid { 
            display: grid; 
            grid-template-columns: repeat(2, 1fr); 
            gap: 15px; 
            margin-bottom: 20px; 
        }
        .toolbar { 
            position: fixed; 
            top: 60px; 
            left: -400px; 
            width: 200px; 
            height: 100%; 
            background-image: linear-gradient(to bottom, lightseagreen, palevioletred); 
            padding: 15px; 
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1); 
            transition: left 0.3s ease-in-out; 
            z-index: 999; 
            overflow-y: auto; 
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        .toolbar.active { 
            left: 0; 
        }
        .toolbar .feature-box { 
            background-color: lightgrey; 
            border-radius: 8px; 
            padding: 12px; 
            margin-bottom: 16px; 
            color: white; 
            font-size: 13px; 
        }
        .toolbar .feature-box h3 { 
            margin: 0 0 8px; 
            font-size: 14px; 
            color: black; 
        }
        .toolbar .feature-box button { 
            width: 100%; 
            padding: 6px; 
            background-color: darkgrey; 
            color: black; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            font-size: 11px; 
            margin-bottom: 4px; 
            transition: background-color 0.3s; 
        }
        .toolbar .feature-box button:hover { 
            background-color: darkslategrey; 
        }
        .toolbar .about-us { 
            text-align: left; 
            display: flex; 
            flex-direction: column; 
            gap: 10px; 
        }
        .toolbar .about-us img { 
            width: 100%; 
            max-width: 150px; 
            border-radius: 8px; 
            margin-bottom: 10px; 
        }
        .toolbar .about-us p { 
            font-size: 12px; 
            color: black; 
            margin: 0; 
        }
        .toolbar .about-us a button { 
            background-color: #007bff; 
            color: white; 
        }
        .toolbar .about-us a button:hover { 
            background-color: #0056b3; 
        }
        .toolbar .user-info { 
            text-align: center; 
        }
        .toolbar .user-info img { 
            width: 40px; 
            height: 40px; 
            border-radius: 50%; 
            margin-bottom: 8px; 
        }
        .toolbar .user-info span { 
            display: block; 
            margin: 4px 0; 
            font-size: 11px; 
            color: black; 
        }
        .toolbar .live-overview { 
            text-align: left; 
        }
        .toolbar .live-overview .status { 
            margin: 8px 0; 
            font-size: 12px; 
            color: black; 
        }
        .toolbar .live-overview .status span { 
            font-weight: bold; 
            color: #007bff; 
        }
        .overview, .user-details, .park-condition-2d { 
            background-color: lightgrey; 
            padding: 10px; 
            border-radius: 8px; 
            border: 2px solid #dc3545; 
            min-height: 150px; 
        }
        .park-condition-2d {
            padding: 15px;
        }
        .overview h1 { 
            margin: 0 0 10px; 
            color: #007bff; 
            font-size: 16px; 
        }
        .stats { 
            display: grid; 
            grid-template-columns: repeat(2, 1fr); 
            gap: 10px; 
            margin-bottom: 10px; 
            font-size: 12px; 
        }
        .stats div { 
            background-color: #e9ecef; 
            padding: 6px; 
            border-radius: 5px; 
            text-align: center; 
        }
        .stats span:first-child { 
            display: block; 
            font-size: 12px; 
            font-weight: bold; 
            color: #555; 
            margin-bottom: 5px; 
        }
        .stats span:last-child { 
            font-size: 12px; 
            color: #007bff; 
        }
        .user-details h2 { 
            margin-top: 0; 
            color: #007bff; 
            font-size: 16px; 
        }
        .user-details .detail { 
            margin-bottom: 10px; 
            font-size: 14px; 
        }
        .user-details .detail label { 
            font-weight: bold; 
            display: block; 
            color: #555; 
        }
        .user-details .detail input, .user-details .detail select, .user-details .detail textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 14px;
            box-sizing: border-box;
        }
        .user-details .actions { 
            display: flex; 
            justify-content: space-between; 
            margin-top: 15px; 
        }
        .user-details .actions button { 
            padding: 8px 12px; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            font-size: 12px; 
            transition: background-color 0.3s; 
        }
        .user-details .actions .in-btn { 
            background-color: green; 
            color: white; 
        }
        .user-details .actions .in-btn:hover { 
            background-color: darkgreen; 
        }
        .user-details .actions .out-btn { 
            background-color: red; 
            color: white; 
        }
        .user-details .actions .out-btn:hover { 
            background-color: darkred; 
        }
        .parking-lot {
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 10px;
        }
        .row {
            display: flex;
            flex-direction: row-reverse;
            gap: 10px;
            justify-content: flex-start;
        }
        .slot {
            border: 1px solid #ccc;
            padding: 10px;
            text-align: center;
            background-color: #e9ecef;
            font-size: 12px;
            border-radius: 5px;
            position: relative;
            width: 50px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .slot.occupied {
            background-color: yellow;
        }
        .slot span {
            font-size: 12px;
            font-weight: bold;
        }
        .slot .car {
            width: 30px;
            height: 15px;
            background-color: red;
            border-radius: 3px;
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            display: none;
            transition: opacity 0.3s ease-in-out;
        }
        .slot.occupied .car {
            display: block;
            animation: carEnter 0.5s ease-in-out;
        }
        @keyframes carEnter {
            from {
                transform: translate(-50%, -50%) scale(0);
                opacity: 0;
            }
            to {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
        }
        @keyframes carExit {
            from {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
            to {
                transform: translate(-50%, -50%) scale(0);
                opacity: 0;
            }
        }
        .slot.occupied.exiting .car {
            animation: carExit 0.5s ease-in-out forwards;
        }
    </style>
</head>
<body>
    <video id="bg-video" autoplay muted loop>
        <source src="https://github.com/Defdava/Digital-Twin-Website-used/blob/main/wave.mp4?raw=true" type="video/mp4">
        Your browser does not support the video tag.
    </video>
    <header>
        <div class="logo" id="toggleToolbar">
            <img src="https://github.com/Defdava/Digital-Twin-Website-used/blob/main/Logo_BRIN.png?raw=true" alt="BRIN Logo">
            <span>BRIN</span>
            <span>Badan Riset Nasional</span>
        </div>
        <div class="header-right">
            <span>Parking Management System</span>
        </div>
    </header>
    <aside class="toolbar" id="toolbar">
        <div class="feature-box about-us">
            <h3>About Us</h3>
            <img src="https://github.com/Defdava/Digital-Twin-Website-used/blob/main/Logo_BRIN.png?raw=true" alt="BRIN Logo">
            <p>BRIN Cisitu Bandung merupakan salah satu kawasan riset milik Badan Riset dan Inovasi Nasional yang berlokasi di Kawasan Sains dan Teknologi Samaun Samadikun, Jalan Sangkuriang, Dago, Kecamatan Coblong, Bandung. Kawasan ini menjadi pusat berbagai kegiatan penelitian dan inovasi, termasuk pengembangan kecerdasan artifisial, keamanan siber, dan teknologi telekomunikasi. Di sini, para peneliti, mahasiswa, dan praktisi dari berbagai institusi berkolaborasi dalam proyek-proyek unggulan seperti digitalisasi naskah kuno berbasis machine learning serta pengembangan solusi teknologi untuk kebutuhan industri dan masyarakat. Fasilitas yang memadai serta lingkungan yang kondusif menjadikan BRIN Cisitu Bandung sebagai salah satu pusat inovasi dan pengembangan ilmu pengetahuan terkemuka di Indonesia.</p>
            <a href="https://share.google/SvuFGBZcGBeEERAHt" target="_blank"><button>For Our Location</button></a>
        </div>
        <div class="feature-box user-info" id="userInfo">
            <h3>User</h3>
            <img id="profilePic" src="/assets/user.JPG" alt="User">
            <span>Welcome Back</span>
            <span id="userName"></span>
            <button class="profile" onclick="window.location.href='profile.html'">Profile</button>
            <button class="form-message" onclick="window.location.href='index.html'">Form Message</button>
            <button class="logout">Log Out</button>
        </div>
        <div class="feature-box live-overview">
            <h3>Live Overview</h3>
            <div class="status">
                <span id="availableSpots">0</span> Available Parking Spots
            </div>
            <div class="status">
                <span id="occupiedSpots">0</span> Occupied Parking Spots
            </div>
            <div class="status">
                Last Activity: <span id="lastActivity">None</span>
            </div>
            <button onclick="refreshOverview()">Refresh</button>
        </div>
    </aside>
    <main class="main-content">
        <div class="main-content-grid">
            <div class="overview">
                <h1>Live Overview</h1>
                <div class="stats">
                    <div><span>Cars</span><span id="occupiedSlots">0 / 20</span></div>
                    <div><span>Slots</span><span id="emptySlots">20 / 20</span></div>
                    <div><span>Time</span><span id="currentTime"></span></div>
                    <div><span>Loyalty Customers</span><span>3</span></div>
                    <div><span>Total Cars In</span><span>74 Today</span></div>
                    <div><span>Total Cars Out</span><span>32 Today</span></div>
                </div>
            </div>
            <div class="user-details">
                <h2>Form Message Parking</h2>
                <div class="detail">
                    <label for="detailName">Nama:</label>
                    <input type="text" id="detailName" readonly>
                </div>
                <div class="detail">
                    <label for="detailIdWorker">ID Karyawan:</label>
                    <input type="text" id="detailIdWorker" readonly>
                </div>
                <div class="detail">
                    <label for="detailPlate">Plat Nomor Mobil:</label>
                    <input type="text" id="detailPlate" readonly>
                </div>
                <div class="detail">
                    <label for="contactNumber">Nomor Kontak:</label>
                    <input type="tel" id="contactNumber" placeholder="Masukkan nomor kontak">
                </div>
                <div class="detail">
                    <label for="parkingNotes">Catatan Parkir:</label>
                    <textarea id="parkingNotes" placeholder="Mas --

ukkan catatan parkir" rows="3"></textarea>
                </div>
                <div class="detail">
                    <label for="slotSelect">Pilih Slot Parkir:</label>
                    <select id="slotSelect">
                        <option value="">-- Pilih Slot --</option>
                        <script>
                            for (let i = 1; i <= 20; i++) {
                                document.write(`<option value="slot_${i}">Slot ${i}</option>`);
                            }
                        </script>
                    </select>
                </div>
                <div class="actions">
                    <button class="in-btn">Mobil Masuk</button>
                    <button class="out-btn">Mobil Keluar</button>
                </div>
            </div>
            <div class="park-condition-2d">
                <h2>Park Condition (2D)</h2>
                <div class="parking-lot">
                    <div class="row">
                        <div class="slot" data-slot="12"><span>12</span><div class="car"></div></div>
                        <div class="slot" data-slot="13"><span>13</span><div class="car"></div></div>
                        <div class="slot" data-slot="14"><span>14</span><div class="car"></div></div>
                        <div class="slot" data-slot="15"><span>15</span><div class="car"></div></div>
                        <div class="slot" data-slot="16"><span>16</span><div class="car"></div></div>
                        <div class="slot" data-slot="17"><span>17</span><div class="car"></div></div>
                        <div class="slot" data-slot="18"><span>18</span><div class="car"></div></div>
                        <div class="slot" data-slot="19"><span>19</span><div class="car"></div></div>
                        <div class="slot" data-slot="20"><span>20</span><div class="car"></div></div>
                    </div>
                    <div class="row">
                        <div class="slot" data-slot="1"><span>1</span><div class="car"></div></div>
                        <div class="slot" data-slot="2"><span>2</span><div class="car"></div></div>
                        <div class="slot" data-slot="3"><span>3</span><div class="car"></div></div>
                        <div class="slot" data-slot="4"><span>4</span><div class="car"></div></div>
                        <div class="slot" data-slot="5"><span>5</span><div class="car"></div></div>
                        <div class="slot" data-slot="6"><span>6</span><div class="car"></div></div>
                        <div class="slot" data-slot="7"><span>7</span><div class="car"></div></div>
                        <div class="slot" data-slot="8"><span>8</span><div class="car"></div></div>
                        <div class="slot" data-slot="9"><span>9</span><div class="car"></div></div>
                        <div class="slot" data-slot="10"><span>10</span><div class="car"></div></div>
                        <div class="slot" data-slot="11"><span>11</span><div class="car"></div></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAef3SJwvVVTunr6CWki79aenfpXlgYc0s",
            authDomain: "digitaltwinparkingbrin.firebaseapp.com",
            databaseURL: "https://digitaltwinparkingbrin-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "digitaltwinparkingbrin",
            storageBucket: "digitaltwinparkingbrin.appspot.com",
            messagingSenderId: "608462498913",
            appId: "1:608462498913:web:73695d8c91f923e2db8e20",
            measurementId: "G-F1TRY65RTG"
        };

        firebase.initializeApp(firebaseConfig);
        const dbRef = firebase.database().ref("slot_parking");

        // Simulated parking data for toolbar (replace with actual API call in production)
        class ParkingSystem {
            constructor() {
                this.parkingData = {
                    availableSpots: 10,
                    occupiedSpots: 5,
                    lastActivity: 'Vehicle entered at ' + new Date().toLocaleTimeString()
                };
            }

            getOverview() {
                return this.parkingData;
            }

            refreshOverview() {
                // Simulate data refresh
                this.parkingData.availableSpots = Math.floor(Math.random() * 20);
                this.parkingData.occupiedSpots = Math.floor(Math.random() * 10);
                this.parkingData.lastActivity = 'Vehicle ' + (Math.random() > 0.5 ? 'entered' : 'exited') + ' at ' + new Date().toLocaleTimeString();
                return this.parkingData;
            }
        }

        const parkingSystem = new ParkingSystem();

        function updateOverviewDisplay() {
            const data = parkingSystem.getOverview();
            document.getElementById('availableSpots').textContent = data.availableSpots;
            document.getElementById('occupiedSpots').textContent = data.occupiedSpots;
            document.getElementById('lastActivity').textContent = data.lastActivity;
        }

        function refreshOverview() {
            parkingSystem.refreshOverview();
            updateOverviewDisplay();
        }

        function updateParkingLot(data) {
            const totalSlots = 20;
            let occupiedCount = 0;
            for (let i = 1; i <= totalSlots; i++) {
                const slotKey = `slot_${i}`;
                const slotEl = document.querySelector(`.slot[data-slot="${i}"]`);
                const isOccupied = data[slotKey] === true;
                if (slotEl) {
                    if (isOccupied) {
                        slotEl.classList.add("occupied");
                        slotEl.querySelector(".car").style.display = "block";
                        occupiedCount++;
                    } else {
                        slotEl.classList.remove("occupied");
                        slotEl.querySelector(".car").style.display = "none";
                    }
                }
            }
            const emptyCount = totalSlots - occupiedCount;
            updateLiveOverview(occupiedCount, emptyCount, totalSlots);
        }

        function updateLiveOverview(occupiedCount, emptyCount, totalSlots) {
            document.getElementById('occupiedSlots').textContent = `${occupiedCount} / ${totalSlots}`;
            document.getElementById('emptySlots').textContent = `${emptyCount} / ${totalSlots}`;
        }

        function setupFirebaseListener() {
            dbRef.on("value", (snapshot) => {
                const data = snapshot.val() || {};
                updateParkingLot(data);
            }, (error) => {
                console.error("❌ Firebase read error:", error);
                alert("Failed to fetch parking data. Please try again.");
            });
        }

        function sendSlotMessage(slotKey, action, user) {
            if (!slotKey) {
                alert('Pilih slot parkir terlebih dahulu!');
                return;
            }
            const timestamp = new Date();
            const options = { timeZone: 'Asia/Jakarta', hour: 'numeric', minute: '2-digit', second: '2-digit', hour12: false };
            const timeString = new Intl.DateTimeFormat('en-US', options).format(timestamp) + ' WIB';
            const contactNumber = document.getElementById('contactNumber').value || 'None';
            const parkingNotes = document.getElementById('parkingNotes').value || 'None';

            firebase.database().ref(`slot_message_user/${slotKey}`).set({
                lastAction: action,
                user: user.username,
                idWorker: user.idWorker,
                plate: user.plateNumber || 'None',
                contactNumber: contactNumber,
                parkingNotes: parkingNotes,
                timestamp: timeString
            }).then(() => {
                alert(`✅ ${action} untuk ${slotKey} berhasil dikirim!`);
                document.getElementById('contactNumber').value = '';
                document.getElementById('parkingNotes').value = '';
            }).catch(err => {
                console.error('❌ Gagal mengirim pesan:', err);
            });
        }

        document.addEventListener("DOMContentLoaded", () => {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (!currentUser) {
                alert('Silakan login terlebih dahulu!');
                window.location.replace('login.html');
                return;
            }
            document.getElementById('userName').textContent = currentUser.username;
            document.getElementById('profilePic').src = currentUser.profilePic || '/assets/user.JPG';
            document.getElementById('detailName').value = currentUser.username;
            document.getElementById('detailIdWorker').value = currentUser.idWorker;
            document.getElementById('detailPlate').value = currentUser.plateNumber || 'None';

            document.querySelector('.logout').addEventListener('click', () => {
                localStorage.removeItem('currentUser');
                alert('Berhasil logout!');
                window.location.replace('login.html');
            });

            document.getElementById('toggleToolbar').addEventListener('click', () => {
                document.getElementById('toolbar').classList.toggle('active');
            });

            function updateClock() {
                const now = new Date();
                const options = { timeZone: 'Asia/Jakarta', hour: 'numeric', minute: '2-digit', second: '2-digit', hour12: false };
                document.getElementById('currentTime').textContent = new Intl.DateTimeFormat('en-US', options).format(now) + ' WIB';
            }
            updateClock();
            setInterval(updateClock, 1000);

            // Initialize Live Overview
            updateOverviewDisplay();
            setupFirebaseListener();

            document.querySelector('.in-btn').addEventListener('click', () => {
                const selectedSlot = document.getElementById('slotSelect').value;
                sendSlotMessage(selectedSlot, 'Mobil Masuk', currentUser);
            });

            document.querySelector('.out-btn').addEventListener('click', () => {
                const selectedSlot = document.getElementById('slotSelect').value;
                sendSlotMessage(selectedSlot, 'Mobil Keluar', currentUser);
            });

            // Prevent Undo/Redo
            document.addEventListener('keydown', (event) => {
                if ((event.ctrlKey || event.metaKey) && (event.key === 'z' || event.key === 'y' || event.key === 'Z' || event.key === 'Y')) {
                    event.preventDefault();
                    event.stopPropagation();
                    console.log('Undo/Redo is disabled');
                }
            });
        });
    </script>
</body>
</html>